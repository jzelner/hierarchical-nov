---
title: "Modeling clustered transmission in a large Norovirus outbreak"
author: Jon Zelner
date: \today
header-includes:
  - \usepackage{graphicx}
--- 

# Introduction
Norovirus (NoV) outbreaks are often characterized by explosive and unpredictable dynamics, as well as patterns of recrudescence in which a declining outbreak resurges. In this paper, we construct a new model of norovirus (NoV) transmission during a large outbreak to understand the role of 1) between-individual heterogeneity in infectiousness and 2) heterogeneous patterns of contact, on the overall outbreak attack rate and outbreak transmission dynamics. To do this, we re-analyzed data from a large Norovirus outbreaks first presented by Heijne et al. [@Heijne2009] using an individual-level, stochastic model of individual-level NoV transmission. To account for heterogeneity in individual infection potential and potential superspreading, we adapted the heterogeneous branching-process framework originally described by Lloyd-Smith et al. [@Lloyd-Smith:2005aa] to allow for finite numbers of susceptibles, and to accomodate contact heterogeneity. 

Such contact heterogeneity, in combination with wide heterogeneity in individual infectiousness, may help to explain the "explosive, but self-limiting" character of large Norovirus outbreaks. Because transmission is often the result of vomiting events, the number of contacts an individual has around the time of illness onset is likely to be a key factor in determining his or her likelihood of either touching off a large outbreak or sustaining an ongoing one. For example, Wikswo et al. [@Wikswo2011] documented a large NoV outbreak in which an individual who vomited during boarding of a cruise ship likely infected many passengers at one time. This individual's impact on the outbreak was likely a function of both the magnitude of the event, i.e. in terms of viral particles shed into the environment, plus the number of individuals she contacted at the time of onset. Given an equally significant vomiting event within her own room, such a passenger would likely have had a diminished epidemiologic impact. 

# Data

We analyze data previously published by Heijne et al. [@Heijne2009] from a large Norovirus outbreak during a scout jamboree in the Netherlands in 2004. Figure \ref{fig:allcases} shows the distribution of cases over time during the outbreak, and Figure \ref{fig:campcases} shows the evolution of the outbreak within the seven individual sub-camps affected during the outbreak. In this earlier analysis, Heijne et al. used a generation time approach in which the likelihood that individual $i$ infected individual $j$ is a function of the time lag between onset of symptoms in $i$ and $j$, and assumed homogeneous patterns of contact between individuals in the different camps. The model employed in the present analysis allows us to look in more detail at the role of heterogeneous contact patterns and susceptible depletion on patterns of transmission in this outbreak, which is characterized by both explosive growth and recrudescence. 


# Methods

In this section, we outline a stochastic, discrete-time model of NoV transmission within and between sub-camps of the outbreak. This model is similar to a susceptible-exposed-infectious-recovered (SEIR) model, with key modifications to accomodate between-individual variability in infectiousness.

We denote the number of *incident* cases observed on day $t$ in camp $j$ to be $y_{jt}$. We denote the unobserved number of *infections* on day $t$ in camp $j$ as $y_{jt}^*$. These values are different because of the latent period between infection and onset of symptoms. Individuals are assumed to be infectious at the beginning of their day of onset. We denote the day of onset of disease for individual $i$ as $z_i$. 

## Modeling the latent period

We utilize the estimates of the mean and variance of NoV incubation period duration published by Lee et al. [@Lee2013] in their systematic review of incubation periods for viral gastroenteritis. Lee et al. assume that NoV incubation periods follow a log-Normal distribution, with a median incubation time of 1.2 days (95% CI = 1.2, 1.3 days) with a dispersion factor (corresponding to the standard deviation of the underlying normal distribution) of 1.56 (95% CI = 1.49, 1.62). In practice, this means that 95% of cases will become symptomatic within 2.5 days of infection (95% CI 2.4-2.6 days). We use a discrete approximation to this value, denoted as $\Omega(x, \mu, \sigma^2)$, where $G(x | \mu, \sigma^2)$ is the cumulative distribution function (CDF) of the log-Normal distribution, for $x \ge 1$, where $x$ is the difference in days between infection and onset:

$$
\Omega(x, \mu, \sigma^2) = G(x | \mu, \sigma^2) - G(x-1 | \mu, \sigma^2)
$$

## Heterogeneous infectiousness 

Each case is assumed to have an individual within-camp reproduction number $\r_i$ drawn from a gamma distribution with shape parameter $r_{k}$ and a scale parameter $r_{\theta}$. So, $r_i \sim Gamma(r_{k}, r_{\theta})$, and mean value $\bar{R} = r_{k} * r_{\theta}$.  However, because within each camp multiple cases may become infectious on a given day, the values of $\r_i$ for each case are not individually identifiable. However, we can take advantage of the fact that the sum of $n$ Gamma-distributed variables is Gamma distributed with shape parameter $\r_{k}*n$ to sample values $r_{jt}$ indicating the daily total infectiousness across all individuals who became infectious in camp $j$ on day $t$, which we can then use to estimate the daily average reproduction number, $\bar{r}_{jt}$. So, for a given camp, $j$:

\begin{gather*}
r_{jt} = \sum_{i=1}^{y_{jt}} r_{ij} \mathcal{I}(t_{ij} = t) \\ 
r_{jt} \sim Gamma(r_{k}y_{jt}, r_{\theta}) \\
\bar{r}_{jt} = r_{jt}/y_{jt}
\end{gather*}

### Time-varying infectiousness

We allow individual infectiousness to decay according to a Geometric distribution with parameter $\gamma \in (0,1]$, where:

$$
g(x | \gamma) = \gamma (1-\gamma)^x 
$$

When $t \ge z_i$, $g(t-z_i)$ is the proportion of the infectiousness of individual $i$ deposited on day $t$. Otherwise, when $t < z_i$, this value is equal to zero, i.e. before the individual becomes infectious. The parameter $\gamma$ has a straightforward interpretation as the proportion of the individual's infectiousness deposited on the day of symptom onset, and the proportion of *remaining* infectiousness deposited each day thereafter.

## Force of infection

We denote the parameter $\zeta$ to be the ratio of an individual's per-capita infectiousness for within-camp contacts ($i = j$) vs. outside-camp contacts ($i \ne j$).  We denote the force of infection in camp $j$ at time $t$ as $\lambda_{j,t}$ and can write this as follows:

$$
\lambda_{jt} =  \sum_{k \le t}g(t-k) \left( \frac{\bar{r}_{jk} y_{jk}}{n_{j}}+ \zeta \sum_{i \ne j} \frac{y_{ik}}{(N-n_{i})} \right)
$$



# Results
```{r, warning=FALSE, message=FALSE, echo=FALSE}
require(readr)
require(dplyr)
require(rstan)
require(glue)
## Load pars

z <- read_csv("../output/scalar_pars.csv")


zeta <- z %>% filter(par == "zeta")

beta <- z %>% filter(par == "log_beta_mu") 
beta_shape <- z%>% filter(par == "beta_shape")

zz <- readRDS("../output/nov_model.Rds") %>% extract

camp_avg <- exp(zz$log_beta_mu)
between_avg <- zz$zeta

camp_ci <- quantile(camp_avg, probs = c(0.025, 0.975))
between_ci <- quantile(between_avg, probs = c(0.025, 0.975))

## Load probability of infection within camp
infection_source <- readRDS("../output/infection_source.Rds")

inf_q <- infection_source$within_camp$p_within %>% quantile(probs = c(0.025, 0.5, 0.975))
```

## Population and within-camp effective reproduction numbers

The average number of *between-camp* transmission events per case is `r sprintf("%0.2f", median(between_avg))`. (95% CI = `r sprintf("%0.2f, %0.2f", between_ci[1], between_ci[2])`). By contrast, the average *within-camp* probability of transmission per 1000 contacts is `r sprintf("%0.2f", median(camp_avg))`. (95% CI = `r sprintf("%0.2f, %0.2f", camp_ci[1], camp_ci[2])`)

However, the value of $r_i$ across individuals is highly dispersed $\alpha$ = `r sprintf("%0.2f", beta_shape[,"median"])` (95% CI = `r sprintf("%0.2f, %0.2f", beta_shape[,"low_ci"], beta_shape[,"high_ci"])`), indicating wide heterogeneity in infectiousness across individuals.

Figure \ref{fig:dailyr} shows the evolution of $R_{eff}$ across all camps over the course of the outbreak. Figure \ref{fig:campr} shows this quantity for each camp individually. Notably, transmission within each camp is characterized by sporadic super-spreading events, rather than a time-constant rate of infectiousness.

## Between vs. within-camp transmission

The differences in the magnitude of the parameters representing within-camp infectiousness, $\beta_{jt}$ and between-camp transmission, $\zeta$ are difficult to interpret directly. This is because at any given time, there may be many more prevalent cases outside of an individual's camp than within it. As a result, even if the per-case rate of transmission is many times lower, the force of infection from outside may be significant enough that a large proportion of cases may still be acocunted for by between-camp transmission. To understand the relative contributions of within vs. between camp transmission, we use the method described by Cauchemez & Ferguson [@Cauchemez:2011aa].  To do this, we calculate the force of infection between-camp, denoted $\eta_{B}$ and, within-camp, denoted $\eta_{W}$, experienced by each infected individual. So:

$$
\eta^{W}_j = \sum_{t < T} y^{*}_{jt}y_{jt} \bar{\beta}_{jt}
$$

And:

$$
\eta^{B}_j = \zeta \sum_{t < T} y_{jt}^* \sum_{i \ne j} y_{it}
$$

Where $y^{*}_{it}$ is the number of new *infections* occurring on each day. Since this value is unobserved, we marginalize over the set of infection times corresponding to each incident case to estimate $\eta_{j}^{W}$ and $\eta_{j}^{B}$.  For each camp, we can then estimate the proportion of cases in camp $j$ acquired in camp $j$ as $\tau_{j} = \eta^{W}_{j}/(\eta^{W}_{j} + \eta^{B}_{J})$. We can then estimate the average prortion of infections acquired within-camp as a weighted sum across camps, $\bar{\tau} = \sum_{i=1}^{j} p_j \tau_j$, where $p_j$ is the proportion of all incident cases occurring in camp $j$.

When we do this, we find that across all camps, approximately `r glue("{pct}%", pct = sprintf("%0.0f", 100*inf_q[2]))` of infections were acquired within-camp (95% CI = `r glue("{low_ci}%,{high_ci}%", low_ci = sprintf("%0.0f", 100*inf_q[1]), high_ci = sprintf("%0.0f", 100*inf_q[3]))`). Figure \ref{fig:camp_p} illustrates variation in within vs. between-camp rates of infection as a function of the total incidence acocunted for by that camp. The figure illustrates a pattern compatible with the finding that most transmission is within-camp, and suggests that in the camps (e.g. 4 & 5) that had the fewest cases, seeding from outside of the camp predominated as a source of risk, whereas in those with the greatest share of cases (2 & 3), within-camp transmission predominated.

\clearpage

# Figures & Tables

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{output/figures/all_camp_cases.pdf}
\caption{Number of new cases per day. Vertical line indicates beginning of hygiene interventions.}
\label{fig:allcases}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{output/figures/cases_by_camp.pdf}
\caption{Number of incident cases in each camp by day of outbreak. Dotted vertical line indicates the start of outbreak interventions.}
\label{fig:campcases}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{images/heijne_eid_daily_r.png}
\caption{Estimated daily $R_{eff}$ from Heijne et al. 2009}
\label{fig:heijne}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=0.6\textwidth]{output/figures/daily_avg_r.pdf}
\caption{Estimated daily avg. reproductive number across all camps. Dashed lines indicated 95\% posterior credible intervals. Dotted line indicates critical value of R = 1.}
\label{fig:dailyr}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{output/figures/daily_camp_r.pdf}
\caption{Estimated daily avg. reproductive number for each camp.Vertical bar indicates beginning of hygiene interventions.}
\label{fig:campr}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{output/figures/p_by_camp.pdf}
\caption{Proportion of infections acquired within-camp, as a function of the total proportion of incident cases within that camp. Points indicated posterior medians; vertical bars indicated 95\% posterior credible intervals. Each point is labelled by the camp in Figure \ref{fig:campcases} it corresponds to.}
\label{fig:camp_p}
\end{figure}


\clearpage

# Supplementary Methods


## Likelihood

The likelihood of observing *each* of the $y_{jt}$ cases in camp $j$ on day $t > 1$ is a function of three components: 

1) Likelihood of escaping infection from $t=1$ until the time of infection for case $i$, $t_{i}^*$.

2) Likelihood of infection in camp $j$ at $t = t^*_i$, and,

3) Likelihood of latent period of duration $z_i - t_i^*$, where $z_i$ is the time of onset for case $i$.

The total system likelihood involves a fourth component:

4 ) Likelihood that the $S_j$ individuals in camp $j$ who did not develop disease during the observation period escaped infection from $t = 1$ until time $T$, when the jamboree ended.

The probability that an individual is infected at time $t_i^*$ is a function of a piecewise exponential likelihood, i.e. 1 and 2 above:

$$ 
Pr(t = t^*_{ij}) = \left(1- e^{-\lambda_{jt}}\right) exp\left(-\sum_{i = 1}^{i < t} \lambda_{ji}\right)
$$


The probability that an individual has a latent period of $z_i - t_i^*$ is described by a geometric distribution with rate parameter $\epsilon$:

$$
Pr(x  = z_i-t^*_{ij}) = \epsilon (1-\epsilon)^{(z_i-t^*_{ij}-1)}
$$

For case $i$, the marginal probability - summing over all possible latent periods - that $t = z_i$ is:

$$
Pr(z_i = t) = \sum_{j = 1}^{z_i - 1} \frac{Pr(j = t^*_{ij}) Pr(x = z_i-j)}{\sum_{k = 1}^{z_i-1}{Pr(x = z_i - k)}}
$$

Then, for all camps, $j$, the probability of observing $y_{j2}$ cases on day 2, ${y_j3}$ on day 3, etc, is:

$$
Pr(y_{jt}) = \prod_{i = 1}^{C} \prod_{t = 1}^{T} y_{it} Pr(z_i = i)
$$

\clearpage


# References
