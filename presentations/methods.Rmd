---
title: "Modeling clustered transmission in a large Norovirus outbreak"
author: Jon Zelner
date: \today
header-includes:
  - \usepackage{graphicx}
--- 

# Introduction

In this paper, we construct a model of norovirus (NoV) transmission during a large outbreak to understand the role of 1) between-individual heterogeneity in infectiousness and 2) heterogeneous patterns of contact, on the overall outbreak attack rate and outbreak transmission dynamics. To do this, we re-analyzed data from a large Norovirus outbreaks first presented by Heijne et al. [@Heijne2009] using an individual-level, stochastic model of individual-level NoV transmission. To account for heterogeneity in individual infection potential and potential superspreading, we adopted the heterogeneous branching-process framework originally described by Lloyd-Smith et al. [@Lloyd-Smith:2005aa] to allow for negative feedback, i.e. susceptible depletion.

# Data

We analyze data previously published by Heijne et al. [@Heijne2009] from a large Norovirus outbreak during a scout jamboree in the Netherlands in 2004. Figure \ref{fig:allcases} shows the distribution of cases over time during the outbreak, and Figure \ref{fig:campcases} shows the evolution of the outbreak within the seven individual sub-camps affected during the outbreak. In this earlier analysis, Heijne et al. used a generation time approach in which the likelihood that individual $i$ infected individual $j$ is a function of the time lag between onset of symptoms in $i$ and $j$. This approach is well-suited to outbreak contexts in which susceptible depletion is negligible, and was originally proposed to measure the pandemic potential of emerging infections, such as monkeypox. 

In the context of a large norovirus outbreak, this approach does not allow for contact heterogeneity or for susceptible depletion to be the cause of an outbreak ending. This issue is particularly acute in the context of the outbreak originally analyzed by Heijne et al. in which individuals were nested within seven camps within the larger scout jamboree. In this case, it is critical to understand whether the outbreak ended as a result of local susceptible depletion, rather than outbreak interventions, as suggested by Heijne et al. For example, Figure \ref{fig:heijne} reproduces the results from the original paper, which show a steep decline in the effective reproduction number $R_{eff}$ after the first day of the outbreak, with this value declining past the critical value of 1 around the time at which outbreak interventions were instituted. 

# Methods

In this section, we outline a stochastic, discrete-time model of NoV transmission within and between sub-camps of the outbreak.

## Data Model

We denote the number of incident cases observed on day $t$ in camp $j$ to be $y_{i,t}$. Individuals are assumed to be infectious at the beginning of their day of onset. We denote the day of onset of disease for individual $i$ as $z_i$. 

### Heterogeneous infectiousness 

Each case is assumed to have a *per-capita* infectiousness $\beta_i$ drawn from a gamma distribution reparameterized in terms of the expected value of the per-capita infectiousness, $\beta_{mu}$, and a shape parameter $\beta_{\alpha}$. So, $\beta_i \sim Gamma(\beta_{\mu}, \beta_{\alpha})$. 

Because within each camp multiple cases may become infectious on a given day, the values of $\beta_i$ are not individually identifiable. However, we can take advantage of the fact that the sum of $n$ Gamma-distributed variables is Gamma distributed with mean $\beta_{\mu} \times n$ to sample values $\beta_{jt}$ indicating the daily average per-capita infectiousness across all individuals who became infectious in camp $j$ on day $t$. 

### Time-varying infectiousness

We allow individual infectiousness to decay according to a Geometric distribution with parameter $\gamma \in (0,1]$, where:

$$
g(x | \gamma) = \gamma (1-\gamma)^x 
$$

When $t \ge z_i$, $g(t-z_i)$ is the proportion of the infectiousness of individual $i$ deposited on day $t$. Otherwise, when $t < z_i$, this value is equal to zero, i.e. before the individual becomes infectious. The parameter $\gamma$ has a straightforward interpretation as the proportion of the individual's infectiousness deposited on the day of symptom onset, and the proportion of *remaining* infectiousness deposited each day thereafter.

### Force of infection

We denote the parameter $\zeta$ to be the ratio of an individual's per-capita infectiousness for within-camp contacts ($i = j$) vs. outside-camp contacts ($i \ne j$).  We denote the force of infection in camp $j$ at time $t$ as $\lambda_{j,t}$ and can write this as follows:

$$
\lambda_{jt} =  \sum_{k \le t}g(t-k) \left( \bar{\beta}_{jk} y_{jk}+ \zeta \sum_{i \ne j} y_{ik} \right)
$$

### Likelihood

The likelihood of observing *each* of the $y_{jt}$ cases in camp $j$ on day $t > 1$ is a function of three components: 

1) Likelihood of escaping infection from $t=1$ until the time of infection for case $i$, $t_{i}^*$.

2) Likelihood of infection in camp $j$ at $t = t^*_i$, and,

3) Likelihood of latent period of duration $z_i - t_i^*$, where $z_i$ is the time of onset for case $i$.

The total system likelihood involves a fourth component:

4 ) Likelihood that the $S_j$ individuals in camp $j$ who did not develop disease during the observation period escaped infection from $t = 1$ until time $T$, when the jamboree ended.

The probability that an individual is infected at time $t_i^*$ is a function of a piecewise exponential likelihood, i.e. 1 and 2 above:

$$ 
Pr(t = t^*_{ij}) = \left(1- e^{-\lambda_{jt}}\right) exp\left(-\sum_{i = 1}^{i < t} \lambda_{ji}\right)
$$


The probability that an individual has a latent period of $z_i - t_i^*$ is described by a geometric distribution with rate parameter $\epsilon$:

$$
Pr(x  = z_i-t^*_{ij}) = \epsilon (1-\epsilon)^{(z_i-t^*_{ij}-1)}
$$

For case $i$, the marginal probability - summing over all possible latent periods - that $t = z_i$ is:

$$
Pr(z_i = t) = \sum_{j = 1}^{z_i - 1} \frac{Pr(j = t^*_{ij}) Pr(x = z_i-j)}{\sum_{k = 1}^{z_i-1}{Pr(x = z_i - k)}}
$$

Then, for all camps, $j$, the probability of observing $y_{j2}$ cases on day 2, ${y_j3}$ on day 3, etc, is:

$$
Pr(y_{jt}) = \prod_{i = 1}^{C} \prod_{t = 1}^{T} y_{it} Pr(z_i = i)
$$




# Results
```{r, warning=FALSE, message=FALSE, echo=FALSE}
require(readr)
require(dplyr)
require(rstan)
require(glue)
## Load pars

z <- read_csv("../output/scalar_pars.csv")


zeta <- z %>% filter(par == "zeta")

beta <- z %>% filter(par == "log_beta_mu") 
beta_shape <- z%>% filter(par == "beta_shape")

zz <- readRDS("../output/nov_model.Rds") %>% extract

camp_avg <- 1000*exp(zz$log_beta_mu)
between_avg <- 1000*zz$zeta

camp_ci <- quantile(camp_avg, probs = c(0.025, 0.975))
between_ci <- quantile(between_avg, probs = c(0.025, 0.975))

## Load probability of infection within camp
infection_source <- readRDS("../output/infection_source.Rds")

inf_q <- infection_source$within_camp$p_within %>% quantile(probs = c(0.025, 0.5, 0.975))
```

The expected number of *between-camp* transmission events per 1000 contacts is `r sprintf("%0.2f", median(between_avg))`. (95% CI = `r sprintf("%0.2f, %0.2f", between_ci[1], between_ci[2])`). By contrast, the average *within-camp* probability of transmission per 1000 contacts is `r sprintf("%0.2f", median(camp_avg))`. (95% CI = `r sprintf("%0.2f, %0.2f", camp_ci[1], camp_ci[2])`)

However, the value of $r_i$ across individuals is highly dispersed $\alpha$ = `r sprintf("%0.2f", beta_shape[,"median"])` (95% CI = `r sprintf("%0.2f, %0.2f", beta_shape[,"low_ci"], beta_shape[,"high_ci"])`), indicating wide heterogeneity in infectiousness across individuals.

## Calculating effective reproduction numbers

We can calculate the individual effective reproduction number, $r_{jt}$ for each infectious individual by multiplying the baseline per-capita rate of infection by the number of people each infectious individual is exposed to both within their camp of residence, and in other camps, as follows:

$$
r_{jt} = \beta_{jt} n_j + \zeta \sum_{i \ne j}^{C} n_i
$$

Figure \ref{fig:dailyr} shows the evolution of $R_{eff}$ across all camps over the course of the outbreak. Figure \ref{fig:campr} shows this quantity for each camp individually. Notably, transmission within each camp is characterized by sporadic super-spreading events, rather than a time-constant rate of infectiousness.

## Between vs. within-camp transmission

The differences in the magnitude of the parameters representing within-camp infectiousness, $\beta_{jt}$ and between-camp transmission, $\zeta$ are difficult to interpet directly. This is because at any given time, there may be many more prevalent cases outside of an individual's camp than within it. As a result, even if the rate of transmission is many times lower, a high proportion of cases may still be acocunted for by between-camp transmission. To understand the relative contributions of within vs. between camp transmission, we use the method described by Cauchemez & Ferguson [@Cauchemez:2011aa]. 

To do this, we calculate the total force of infection between-camp, denoted $\lambda_{B}$ and, within-camp, denoted $\lambda_{W}$. So:

$$
\lambda^{W}_j = \sum_{t < T} y_{jt} \bar{\beta}_{jt}
$$

And:

$$
\lambda^{B}_j = \zeta \sum_{t < T} \sum_{i \ne j} y_{it}
$$
For each camp, we can then estimate the proportion of cases in camp $j$ acquired in camp $j$ as $\tau_{j} = \lambda^{W}_{j}/(\lambda^{W}_{j} + \lambda^{B}_{J})$. We can then estimate the average prortion of infections acquired within-camp as a weighted sum across camps, $\bar{\tau} = \sum_{i=1}^{j} p_j \tau_j$, where $p_j$ is the proportion of total cases in camp $j$.

When we do this, we find that across all camps, approximately `r glue("{pct}%", pct = sprintf("%0.0f", 100*inf_q[2]))` infections were acquired within-camp (95% CI = `r glue("{low_ci}%,{high_ci}%", low_ci = sprintf("%0.0f", 100*inf_q[1]), high_ci = sprintf("%0.0f", 100*inf_q[3]))`).

# Figures & Tables

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{output/figures/all_camp_cases.pdf}
\caption{Number of new cases per day. Vertical line indicates beginning of hygiene interventions.}
\label{fig:allcases}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{output/figures/cases_by_camp.pdf}
\caption{Number of incident cases in each camp by day of outbreak. Dotted vertical line indicates the start of outbreak interventions.}
\label{fig:campcases}
\end{figure}

\begin{figure}[h]
\centering
\includegraphics[width=0.6\textwidth]{images/heijne_eid_daily_r.png}
\caption{Estimated daily $R_{eff}$ from Heijne et al. 2009}
\label{fig:heijne}
\end{figure}


\begin{figure}
\centering
\includegraphics[width=0.6\textwidth]{output/figures/daily_avg_r.pdf}
\caption{Estimated daily avg. reproductive number across all camps. Dashed lines indicated 95\% posterior credible intervals. Dotted line indicates critical value of R = 1.}
\label{fig:dailyr}
\end{figure}

\begin{figure}
\centering
\includegraphics[width=0.7\textwidth]{output/figures/daily_camp_r.pdf}
\caption{Estimated daily avg. reproductive number for each camp.Vertical bar indicates beginning of hygiene interventions.}
\label{fig:campr}
\end{figure}

\clearpage

# References
